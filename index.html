<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalmeron Chat</title>
<style>
body{font-family:"Cairo",sans-serif;background:radial-gradient(circle at top,#2a0073,#000);color:aqua;margin:0;height:100vh;overflow:hidden;display:flex;flex-direction:column}
header{position:fixed;top:10px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.6);border:1px solid rgba(0,255,255,.3);border-radius:25px;padding:12px 40px;font-size:22px;color:aqua;box-shadow:0 0 20px rgba(0,255,255,.25);text-align:center;z-index:1000;backdrop-filter:blur(5px);max-width:95%;cursor:pointer}
#chat{flex:1;overflow-y:auto;padding:80px 20px 150px;display:flex;flex-direction:column}
#chat::-webkit-scrollbar{width:8px}
#chat::-webkit-scrollbar-track{background:rgba(0,255,255,.05);border-radius:10px}
#chat::-webkit-scrollbar-thumb{background:rgba(0,255,255,.3);border-radius:10px;border:2px solid transparent;background-clip:padding-box}
#chat::-webkit-scrollbar-thumb:hover{background:rgba(0,255,255,.5)}
.msg{margin:10px;padding:14px 18px;border-radius:20px;max-width:75%;line-height:1.8;font-size:16px;word-wrap:break-word;animation:fadeIn .4s}
.user{background:rgba(0,255,255,.15);color:aqua;align-self:flex-end;border:1px solid rgba(0,255,255,.3);margin-left:auto;text-align:right;direction:rtl}
.bot{background:rgba(0,0,0,.45);color:#8ff;align-self:flex-start;border:1px solid rgba(0,255,255,.2);text-align:right;direction:rtl}
.user,.bot{max-width:80%;min-width:120px}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.input-container{position:fixed;bottom:15px;left:50%;transform:translateX(-50%);display:flex;align-items:flex-end;gap:12px;width:94%;max-width:1000px;min-width:320px;z-index:100}
.input-area{flex:1;background:rgba(0,0,0,.45);border:1px solid rgba(0,255,255,.4);border-radius:25px;padding:0 60px 0 16px;box-shadow:0 0 15px rgba(0,255,255,.15);display:flex;align-items:center;transition:all .3s;backdrop-filter:blur(8px)}
.input-area:focus-within{box-shadow:0 0 20px rgba(0,255,255,.4);border-color:rgba(0,255,255,.7)}
textarea{flex:1;resize:none;padding:12px 0;font-size:17px;border:none;outline:none;background:transparent;color:#e0ffff;height:auto;min-height:24px;max-height:360px;direction:rtl;text-align:right;line-height:1.5;box-sizing:border-box;overflow-y:auto;word-wrap:break-word;font-family:"Cairo",sans-serif;caret-color:#00ffff!important}
textarea::selection{background:rgba(0,255,255,.3)}
textarea::-webkit-scrollbar{width:6px}
textarea::-webkit-scrollbar-track{background:rgba(0,255,255,.05);border-radius:10px}
textarea::-webkit-scrollbar-thumb{background:rgba(0,255,255,.3);border-radius:10px;border:1px solid transparent;background-clip:padding-box}
textarea::-webkit-scrollbar-thumb:hover{background:rgba(0,255,255,.5)}
textarea::placeholder{color:rgba(0,255,255,.6);font-size:15px}
.action-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:36px;height:36px;border-radius:50%;background:rgba(0,255,255,.15);border:1px solid rgba(0,255,255,.5);display:flex;justify-content:center;align-items:center;cursor:pointer;transition:all .3s;box-shadow:0 0 12px rgba(0,255,255,.4);z-index:10}
.action-btn:hover{background:rgba(0,255,255,.3);transform:translateY(-50%) scale(1.1)}
.send-btn{width:44px;height:44px;border-radius:50%;background:rgba(0,255,255,.2);border:1px solid rgba(0,255,255,.8);display:flex;justify-content:center;align-items:center;cursor:pointer;transition:all .3s;box-shadow:0 0 10px rgba(0,255,255,.8)}
.send-btn.active{background:rgba(0,255,255,.3);transform:scale(1.1)}
.send-btn:hover{background:rgba(0,255,255,.4);transform:scale(1.15)}
.send-icon-img{width:22px;height:22px;filter:drop-shadow(0 0 3px aqua)}
#actionMenu{position:fixed;right:50%;transform:translateX(50%);bottom:75px;display:flex;flex-direction:column;gap:12px;transition:all .3s;opacity:0;visibility:hidden;z-index:99;width:94%;max-width:1000px;align-items:flex-end}
#actionMenu.open{opacity:1;visibility:visible;bottom:75px}
.mic-btn,.image-btn{width:44px;height:44px;border-radius:50%;background:rgba(0,0,0,.7);border:2px solid rgba(0,255,255,.7);display:flex;justify-content:center;align-items:center;cursor:pointer;transition:all .3s;box-shadow:0 0 15px rgba(0,255,255,.6)}
.mic-btn:hover,.image-btn:hover{background:rgba(0,255,255,.15);transform:scale(1.1)}
.mic-btn.recording{background:#ff0050;animation:pulse 1.5s infinite;box-shadow:0 0 20px #ff0050}
@keyframes pulse{0%{box-shadow:0 0 20px #ff0050}50%{box-shadow:0 0 30px #ff3399}100%{box-shadow:0 0 20px #ff0050}}
.snowflake{position:absolute;background:rgba(255,255,255,.8);border-radius:50%;pointer-events:none;z-index:1}

/* Personal Profile Section in Chat History */
.personal-profile-section {
    background: rgba(0, 255, 255, 0.15);
    border: 1px solid rgba(0, 255, 255, 0.4);
    border-radius: 15px;
    padding: 15px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
}
.personal-profile-section:hover {
    background: rgba(0, 255, 255, 0.25);
    transform: translateY(-2px);
    border-color: rgba(0, 255, 255, 0.6);
}
.personal-profile-section h3 {
    margin: 0 0 8px 0;
    color: aqua;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.personal-profile-section h3::before {
    content: "üë§";
    font-size: 20px;
}
.personal-profile-section p {
    margin: 0;
    color: #ccc;
    font-size: 14px;
}
.personal-profile-section .edit-icon {
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 24px;
    height: 24px;
    background: rgba(0, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    color: aqua;
    font-size: 14px;
}

/* New Chat Button */
.new-chat-button {
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 200, 255, 0.4));
    border: 1px solid rgba(0, 255, 255, 0.7);
    border-radius: 15px;
    padding: 15px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    text-align: center;
}
.new-chat-button:hover {
    background: linear-gradient(135deg, rgba(0, 255, 255, 0.4), rgba(0, 180, 255, 0.5));
    transform: translateY(-2px);
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
}
.new-chat-button h3 {
    margin: 0;
    color: aqua;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.new-chat-button h3::before {
    content: "‚ú®";
    font-size: 20px;
}

/* Favorites Section Header */
.favorites-header {
    background: rgba(255, 215, 0, 0.15);
    border: 1px solid rgba(255, 215, 0, 0.4);
    border-radius: 12px;
    padding: 10px 15px;
    margin: 15px 0 10px 0;
    color: #ffd700;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}
.favorites-header::before {
    content: "‚≠ê ";
}

/* Regular Chats Header */
.chats-header {
    background: rgba(0, 255, 255, 0.1);
    border: 1px solid rgba(0, 255, 255, 0.3);
    border-radius: 12px;
    padding: 10px 15px;
    margin: 15px 0 10px 0;
    color: #8ff;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
}
.chats-header::before {
    content: "üí¨ ";
}

/* Chat History Modal */
#chatHistoryModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:2000;backdrop-filter:blur(10px)}
.chat-history-card{background:rgba(20,0,40,.9);border:1px solid rgba(0,255,255,.4);border-radius:25px;padding:30px;width:90%;max-width:500px;box-shadow:0 0 30px rgba(0,255,255,.3);direction:rtl;text-align:center;max-height:80vh;overflow-y:auto}
.chat-history-card h2{margin-top:0;margin-bottom:25px;color:aqua;font-size:24px;border-bottom:1px solid rgba(0,255,255,.3);padding-bottom:15px}
.chat-history-item{background:rgba(0,0,0,.3);border:1px solid rgba(0,255,255,.2);border-radius:15px;padding:15px;margin:10px 0;cursor:pointer;transition:all .3s;position:relative}
.chat-history-item:hover{background:rgba(0,255,255,.1);transform:translateY(-2px);border-color:rgba(0,255,255,.5)}
.chat-history-item h3{margin:0 0 8px 0;color:#8ff;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-history-item p{margin:0;color:#ccc;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-history-item .chat-actions{position:absolute;left:10px;top:50%;transform:translateY(-50%);display:flex;gap:8px}
.chat-action-btn{width:28px;height:28px;border-radius:50%;border:none;background:rgba(0,255,255,.2);color:aqua;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:all .3s;font-size:14px}
.chat-action-btn:hover{background:rgba(0,255,255,.4);transform:scale(1.1)}
.chat-action-btn.delete{background:rgba(255,0,80,.2);color:#ff66aa}
.chat-action-btn.delete:hover{background:rgba(255,0,80,.4)}
.chat-action-btn.favorite{background:rgba(255,215,0,.2);color:#ffd700}
.chat-action-btn.favorite:hover{background:rgba(255,215,0,.4)}
.chat-action-btn.favorite.favorited{background:rgba(255,215,0,.6);color:#fff}
.close-modal{position:absolute;top:15px;right:15px;width:30px;height:30px;border-radius:50%;background:rgba(255,0,80,.3);color:#ff66aa;border:none;cursor:pointer;font-size:18px;display:flex;justify-content:center;align-items:center}
.close-modal:hover{background:rgba(255,0,80,.5);transform:rotate(90deg)}

/* Profile Modal */
#profileModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:2000;backdrop-filter:blur(10px)}
.profile-card{background:rgba(20,0,40,.9);border:1px solid rgba(0,255,255,.4);border-radius:25px;padding:30px;width:90%;max-width:450px;box-shadow:0 0 30px rgba(0,255,255,.3);direction:rtl;text-align:center}
.profile-card h2{margin-top:0;margin-bottom:25px;color:aqua;font-size:24px}
.form-group{margin-bottom:20px;text-align:right}
.form-group label{display:block;margin-bottom:8px;color:#8ff;font-size:16px}
.form-group input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(0,255,255,.3);background:rgba(0,0,0,.4);color:#e0ffff;font-size:16px;direction:rtl;text-align:right;box-sizing:border-box}
.form-group input::placeholder{color:rgba(0,255,255,.5)}
.button-group{display:flex;gap:15px;justify-content:center;margin-top:25px}
.btn{padding:12px 25px;border-radius:20px;border:none;font-size:16px;font-weight:bold;cursor:pointer;transition:all .3s;font-family:"Cairo",sans-serif}
.btn-save{background:rgba(0,255,255,.2);color:aqua;border:1px solid rgba(0,255,255,.7);box-shadow:0 0 15px rgba(0,255,255,.4)}
.btn-save:hover{background:rgba(0,255,255,.3);transform:translateY(-2px)}
.btn-cancel{background:rgba(255,0,80,.2);color:#ff66aa;border:1px solid rgba(255,0,80,.7);box-shadow:0 0 15px rgba(255,0,80,.4)}
.btn-cancel:hover{background:rgba(255,0,80,.3);transform:translateY(-2px)}

/* Initial Setup Card */
#initialSetupCard {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    backdrop-filter: blur(10px);
}
.initial-setup-card {
    background: rgba(20, 0, 40, 0.9);
    border: 1px solid rgba(0, 255, 255, 0.4);
    border-radius: 25px;
    padding: 30px;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
    direction: rtl;
    text-align: center;
}
.initial-setup-card h2 {
    margin-top: 0;
    margin-bottom: 25px;
    color: aqua;
    font-size: 24px;
}
.initial-form-group {
    margin-bottom: 20px;
    text-align: right;
}
.initial-form-group label {
    display: block;
    margin-bottom: 8px;
    color: #8ff;
    font-size: 16px;
}
.initial-form-group input {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid rgba(0, 255, 255, 0.3);
    background: rgba(0, 0, 0, 0.4);
    color: #e0ffff;
    font-size: 16px;
    direction: rtl;
    text-align: right;
    box-sizing: border-box;
}
.initial-form-group input::placeholder {
    color: rgba(0, 255, 255, 0.5);
}
.initial-button-group {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
}
.initial-btn {
    padding: 12px 25px;
    border-radius: 20px;
    border: none;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-family: "Cairo", sans-serif;
}
.btn-continue {
    background: rgba(0, 255, 255, 0.2);
    color: aqua;
    border: 1px solid rgba(0, 255, 255, 0.7);
    box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
}
.btn-continue:hover {
    background: rgba(0, 255, 255, 0.3);
    transform: translateY(-2px);
}
.btn-skip {
    background: rgba(255, 0, 80, 0.2);
    color: #ff66aa;
    border: 1px solid rgba(255, 0, 80, 0.7);
    box-shadow: 0 0 15px rgba(255, 0, 80, 0.4);
}
.btn-skip:hover {
    background: rgba(255, 0, 80, 0.3);
    transform: translateY(-2px);
}

/* Logout Button */
.logout-btn {
    background: rgba(255, 0, 80, 0.2);
    color: #ff66aa;
    border: 1px solid rgba(255, 0, 80, 0.7);
    border-radius: 15px;
    padding: 8px 15px;
    margin-top: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-family: "Cairo", sans-serif;
    display: inline-block;
}
.logout-btn:hover {
    background: rgba(255, 0, 80, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 0 10px rgba(255, 0, 80, 0.4);
}

@media (max-width:768px){
    .input-container,#actionMenu{width:96%;max-width:96%}
    textarea{font-size:16px;max-height:300px}
    .user,.bot{max-width:85%}
    .profile-card,.chat-history-card,.initial-setup-card{padding:20px;width:95%}
    .form-group input,.initial-form-group input{font-size:15px;padding:10px}
    .chat-history-item,.personal-profile-section,.new-chat-button{padding:12px}
    .personal-profile-section h3,.new-chat-button h3{font-size:16px}
    .favorites-header,.chats-header{font-size:14px;padding:8px 12px}
}
@media (max-width:500px){
    header{font-size:18px;padding:10px 25px}
    .input-container{width:96%;bottom:10px}
    textarea{font-size:16px;max-height:270px}
    .input-area{padding:0 50px 0 12px;border-radius:20px}
    .action-btn{width:32px;height:32px;right:8px}
    .send-btn,.mic-btn,.image-btn{width:40px;height:40px}
    .user,.bot{max-width:90%;font-size:15px}
    .btn,.initial-btn{padding:10px 20px;font-size:15px}
    .chat-action-btn{width:24px;height:24px;font-size:12px}
    .close-modal{width:26px;height:26px;font-size:16px}
    .personal-profile-section,.new-chat-button{padding:10px}
    .personal-profile-section h3,.new-chat-button h3{font-size:15px}
    .favorites-header,.chats-header{font-size:13px;padding:6px 10px}
    .personal-profile-section .edit-icon{width:20px;height:20px;font-size:12px}
}
</style>
</head>
<body>
<header id="appHeader">Kalmeron</header>
<div id="chat"></div>

<div class="input-container">
    <div class="input-area">
        <input type="file" id="imageUpload" accept="image/*" style="display:none">
        <textarea id="msg" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸáŸÜÿß..." rows="1"></textarea>
        <div class="action-btn" id="actionBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="aqua">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
        </div>
    </div>
    <div class="send-btn" id="sendBtn">
        <img src="up-arrow.png" alt="Send" class="send-icon-img">
    </div>
</div>

<div id="actionMenu">
    <div class="mic-btn" id="micBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="aqua">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
    </div>
    <div class="image-btn" id="imageUploadBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="aqua">
            <path d="M19 5H5c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 12H5l4-5 2.5 3.01L15 11l4 5v-4z"/>
        </svg>
    </div>
</div>

<!-- Chat History Modal -->
<div id="chatHistoryModal">
    <div class="chat-history-card">
        <button class="close-modal" id="closeChatHistory">&times;</button>
        <h2>ŸÖÿ≠ÿßÿØÿ´ÿßÿ™Ÿä</h2>
        <div id="chatHistoryList">
            <!-- Chat history items will be loaded here -->
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div id="profileModal">
    <div class="profile-card">
        <h2>ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®</h2>
        <div class="form-group">
            <label for="editName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ:</label>
            <input type="text" id="editName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÉÿßŸÖŸÑ" maxlength="50">
        </div>
        <div class="form-group">
            <label for="editBirthDate">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ:</label>
            <input type="date" id="editBirthDate">
        </div>
        <div class="button-group">
            <button class="btn btn-cancel" id="modalCancelBtn">ÿ•ŸÑÿ∫ÿßÿ°</button>
            <button class="btn btn-save" id="modalSaveBtn">ŸÖŸàÿßŸÅŸÇ</button>
        </div>
    </div>
</div>

<!-- Initial Setup Card -->
<div id="initialSetupCard">
    <div class="initial-setup-card">
        <h2>ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ŸÉÿßŸÑŸÖŸäÿ±ŸàŸÜ!</h2>
        <p style="color:rgba(0,255,255,0.8);margin-bottom:25px;">ŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ÿ£ŸÅÿ∂ŸÑÿå Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ŸÉ ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ©</p>
        <div class="initial-form-group">
            <label for="initialName">ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ:</label>
            <input type="text" id="initialName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ ÿßŸÑŸÉÿßŸÖŸÑ" maxlength="50">
        </div>
        <div class="initial-form-group">
            <label for="initialBirthDate">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ:</label>
            <input type="date" id="initialBirthDate">
        </div>
        <div class="initial-button-group">
            <button class="initial-btn btn-continue" id="continueInitialBtn">ÿßÿ≥ÿ™ŸÖÿ±ÿßÿ±</button>
        </div>
    </div>
</div>

<script>
function createSnowflakes(){const c=document.body;for(let i=0;i<50;i++){const s=document.createElement('div');s.classList.add('snowflake');const z=Math.random()*3+1;s.style.width=`${z}px`;s.style.height=`${z}px`;s.style.left=`${Math.random()*100}vw`;s.style.top=`${-z}px`;s.style.opacity=Math.random()*.4+.2;s.style.animation=`fall ${Math.random()*12+8}s linear infinite`;s.style.setProperty('--horizontal-move',`${(Math.random()-.5)*30}px`);c.appendChild(s)}const t=document.createElement('style');t.textContent=`@keyframes fall{0%{transform:translateY(0) translateX(0)}100%{transform:translateY(100vh) translateX(var(--horizontal-move,0))}}`;document.head.appendChild(t)}createSnowflakes();

const chat=document.getElementById("chat"),msg=document.getElementById("msg"),sendBtn=document.getElementById("sendBtn"),actionBtn=document.getElementById("actionBtn"),actionMenu=document.getElementById("actionMenu"),micBtn=document.getElementById("micBtn"),imageUploadBtn=document.getElementById("imageUploadBtn"),imageUpload=document.getElementById("imageUpload"),appHeader=document.getElementById("appHeader"),profileModal=document.getElementById("profileModal"),editName=document.getElementById("editName"),editBirthDate=document.getElementById("editBirthDate"),modalCancelBtn=document.getElementById("modalCancelBtn"),modalSaveBtn=document.getElementById("modalSaveBtn"),chatHistoryModal=document.getElementById("chatHistoryModal"),chatHistoryList=document.getElementById("chatHistoryList"),closeChatHistory=document.getElementById("closeChatHistory");

// Initial Setup Elements
const initialSetupCard = document.getElementById("initialSetupCard");
const initialName = document.getElementById("initialName");
const initialBirthDate = document.getElementById("initialBirthDate");
const continueInitialBtn = document.getElementById("continueInitialBtn");

let isThinking=false;
let currentChatId = null;

// User Management
function checkUser(){const d=localStorage.getItem('kalmeronUserData');return d?JSON.parse(d):null;}
function saveUser(n,b){localStorage.setItem('kalmeronUserData',JSON.stringify({name:n,birthDate:b,registeredAt:new Date().toISOString()}));}
function clearUser(){localStorage.removeItem('kalmeronUserData');}

// Create Personal Profile Section
function createPersonalProfileSection() {
    const profileSection = document.createElement('div');
    profileSection.className = 'personal-profile-section';
    
    const user = checkUser();
    const displayName = user && user.name !== 'ÿ≤ÿßÿ¶ÿ±' ? user.name : 'ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä';
    
    profileSection.innerHTML = `
        <h3>${displayName}</h3>
        <p>ÿßÿ∂ÿ∫ÿ∑ ŸÑÿ™ÿπÿØŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ÿ≥ÿßÿ®ŸÉ</p>
        <div class="edit-icon">‚úèÔ∏è</div>
    `;
    
    profileSection.addEventListener('click', () => {
        showProfile();
    });
    
    return profileSection;
}

// Create Logout Button
function createLogoutButton() {
    const logoutBtn = document.createElement('div');
    logoutBtn.className = 'logout-btn';
    logoutBtn.textContent = 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨';
    logoutBtn.addEventListener('click', () => {
        if(confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
            clearUser();
            location.reload();
        }
    });
    return logoutBtn;
}

// Create New Chat Button
function createNewChatButton() {
    const newChatButton = document.createElement('div');
    newChatButton.className = 'new-chat-button';
    newChatButton.innerHTML = '<h3>ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©</h3>';
    
    newChatButton.addEventListener('click', () => {
        startNewChat();
        chatHistoryModal.style.display = 'none';
    });
    
    return newChatButton;
}

// Show Profile Modal
function showProfile(){
    const u=checkUser();
    if(u){
        editName.value=u.name;
        editBirthDate.value=u.birthDate;
        profileModal.style.display='flex';
    }
}

// Start New Chat
function startNewChat() {
    chat.innerHTML = '';
    currentChatId = null;
    const user = checkUser();
    loadWelcome(user);
}

// Chat History Management
function generateChatId() {
    return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function getCurrentChatTitle() {
    const firstUserMsg = document.querySelector('.msg.user');
    if (firstUserMsg && firstUserMsg.textContent.trim()) {
        return firstUserMsg.textContent.trim().substring(0, 30) + (firstUserMsg.textContent.length > 30 ? '...' : '');
    }
    return 'ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©';
}

function saveCurrentChat() {
    if (!chat.children.length) return null;
    
    const chatMessages = [];
    const messages = chat.querySelectorAll('.msg');
    messages.forEach(msg => {
        const sender = msg.classList.contains('user') ? 'user' : 'bot';
        chatMessages.push({
            sender: sender,
            content: msg.textContent
        });
    });
    
    const chatData = {
        id: currentChatId || generateChatId(),
        title: getCurrentChatTitle(),
        messages: chatMessages,
        timestamp: new Date().toISOString(),
        favorited: false
    };
    
    // Get existing chats
    const chats = JSON.parse(localStorage.getItem('kalmeronChats') || '[]');
    
    // Remove existing chat if it exists
    const existingIndex = chats.findIndex(c => c.id === chatData.id);
    if (existingIndex !== -1) {
        chats[existingIndex] = chatData;
    } else {
        chats.unshift(chatData); // Add to beginning
        // Keep only last 50 chats
        if (chats.length > 50) chats.splice(50);
    }
    
    localStorage.setItem('kalmeronChats', JSON.stringify(chats));
    currentChatId = chatData.id;
    return chatData.id;
}

function loadChatHistory() {
    const chats = JSON.parse(localStorage.getItem('kalmeronChats') || '[]');
    chatHistoryList.innerHTML = '';
    
    // Add Personal Profile Section at the top
    const personalProfileSection = createPersonalProfileSection();
    chatHistoryList.appendChild(personalProfileSection);
    
    // Add Logout Button
    const logoutBtn = createLogoutButton();
    chatHistoryList.appendChild(logoutBtn);
    
    // Add New Chat Button
    const newChatButton = createNewChatButton();
    chatHistoryList.appendChild(newChatButton);
    
    if (chats.length === 0) {
        chatHistoryList.innerHTML += '<p style="color:rgba(0,255,255,0.6);margin:20px 0;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿ≥ÿßÿ®ŸÇÿ©</p>';
        return;
    }
    
    // Separate favorites and regular chats
    const favorites = chats.filter(chat => chat.favorited);
    const regularChats = chats.filter(chat => !chat.favorited);
    
    // Add Favorites section if exists
    if (favorites.length > 0) {
        const favoritesHeader = document.createElement('div');
        favoritesHeader.className = 'favorites-header';
        favoritesHeader.textContent = 'ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©';
        chatHistoryList.appendChild(favoritesHeader);
        
        favorites.forEach(chat => {
            addChatItem(chat);
        });
    }
    
    // Add Regular Chats section if exists
    if (regularChats.length > 0) {
        const chatsHeader = document.createElement('div');
        chatsHeader.className = 'chats-header';
        chatsHeader.textContent = 'ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ';
        chatHistoryList.appendChild(chatsHeader);
        
        regularChats.forEach(chat => {
            addChatItem(chat);
        });
    }
}

function addChatItem(chat) {
    const chatItem = document.createElement('div');
    chatItem.className = 'chat-history-item';
    chatItem.dataset.chatId = chat.id;
    
    const date = new Date(chat.timestamp);
    const formattedDate = date.toLocaleDateString('ar-EG') + ' ' + date.toLocaleTimeString('ar-EG', {hour:'2-digit',minute:'2-digit'});
    
    chatItem.innerHTML = `
        <div class="chat-actions">
            <button class="chat-action-btn favorite favorited" data-chat-id="${chat.id}">
                ‚òÖ
            </button>
            <button class="chat-action-btn delete" data-chat-id="${chat.id}">√ó</button>
        </div>
        <h3>${chat.title}</h3>
        <p>${formattedDate}</p>
    `;
    
    chatItem.addEventListener('click', (e) => {
        if (!e.target.closest('.chat-action-btn')) {
            loadChat(chat.id);
            chatHistoryModal.style.display = 'none';
        }
    });
    
    // Add event listeners for action buttons
    const favoriteBtn = chatItem.querySelector('.chat-action-btn.favorite');
    const deleteBtn = chatItem.querySelector('.chat-action-btn.delete');
    
    favoriteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleFavoriteChat(chat.id);
    });
    
    deleteBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        deleteChat(chat.id);
    });
    
    chatHistoryList.appendChild(chatItem);
}

function loadChat(chatId) {
    const chats = JSON.parse(localStorage.getItem('kalmeronChats') || '[]');
    const chatToLoad = chats.find(c => c.id === chatId);
    
    if (chatToLoad) {
        chat.innerHTML = '';
        chatToLoad.messages.forEach(msg => {
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${msg.sender}`;
            msgDiv.textContent = msg.content;
            chat.appendChild(msgDiv);
        });
        currentChatId = chatId;
        chat.scrollTop = chat.scrollHeight;
    }
}

function toggleFavoriteChat(chatId) {
    const chats = JSON.parse(localStorage.getItem('kalmeronChats') || '[]');
    const chatIndex = chats.findIndex(c => c.id === chatId);
    if (chatIndex !== -1) {
        chats[chatIndex].favorited = !chats[chatIndex].favorited;
        localStorage.setItem('kalmeronChats', JSON.stringify(chats));
        loadChatHistory();
    }
}

function deleteChat(chatId) {
    if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ≠ÿßÿØÿ´ÿ©ÿü')) {
        const chats = JSON.parse(localStorage.getItem('kalmeronChats') || '[]');
        const filteredChats = chats.filter(c => c.id !== chatId);
        localStorage.setItem('kalmeronChats', JSON.stringify(filteredChats));
        
        // If we're deleting the current chat, start a new one
        if (currentChatId === chatId) {
            chat.innerHTML = '';
            currentChatId = null;
            const user = checkUser();
            loadWelcome(user);
        }
        
        loadChatHistory();
    }
}

function hideProfile(){profileModal.style.display='none';}
function hideChatHistory(){chatHistoryModal.style.display='none';}

function loadWelcome(u){const w=u?`ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÖÿ¨ÿØÿØÿßŸãÿå ${u.name}! üåü`:"ÿßŸáŸÑÿß ÿ®ŸÉ ŸÅŸä ŸÉÿßŸÑŸÖŸäÿ±ŸàŸÜ! ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ŸáŸÜÿß...";const m=document.createElement("div");m.className="msg bot";m.textContent=w;chat.appendChild(m);setTimeout(()=>msg.focus(),500);}

function adjustHeight(){msg.style.height='auto';const h=window.innerWidth<=500?270:360;msg.style.height=Math.min(msg.scrollHeight,h)+'px';msg.style.overflowY=msg.scrollHeight>h?'auto':'hidden';}
function updateSendBtn(){sendBtn.classList.toggle('active',!!(msg.value.trim()||imageUpload.files.length>0));}
function closeActionMenu(){actionMenu.classList.remove('open');actionBtn.classList.remove('active');}

// Event Listeners
modalSaveBtn.addEventListener('click',()=>{const n=editName.value.trim(),b=editBirthDate.value;if(!n||!b)return;const d=new Date(b),t=new Date(),m=new Date();m.setFullYear(m.getFullYear()-120);if(d>=t||d<m)return;saveUser(n,b);hideProfile();chat.innerHTML='';loadWelcome({name:n});});
modalCancelBtn.addEventListener('click',hideProfile);
closeChatHistory.addEventListener('click',hideChatHistory);

appHeader.addEventListener('click',()=>{loadChatHistory();chatHistoryModal.style.display='flex';});

actionBtn.addEventListener('click',()=>{if(isThinking)return;actionMenu.classList.toggle('open');actionBtn.classList.toggle('active');});
imageUploadBtn.addEventListener('click',()=>{closeActionMenu();imageUpload.click();});
imageUpload.addEventListener('change',updateSendBtn);

sendBtn.addEventListener('click',()=>{if(msg.value.trim()&&!isThinking)sendMessage();});
msg.addEventListener("keydown",(e)=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();if(msg.value.trim()&&!isThinking)sendMessage();}});
msg.addEventListener("input",()=>{adjustHeight();updateSendBtn();});

function sendMessage(){const t=msg.value.trim();if(!t)return;const u=document.createElement("div");u.className="msg user";u.textContent=t;chat.appendChild(u);msg.value="";adjustHeight();updateSendBtn();isThinking=true;setTimeout(()=>{const b=document.createElement("div");b.className="msg bot";b.textContent="ÿ¥ŸÉÿ±ÿßŸã ÿπŸÑŸâ ÿ±ÿ≥ÿßŸÑÿ™ŸÉ! Ÿáÿ∞ÿß ÿ±ÿØ ÿ™ÿ¨ÿ±Ÿäÿ®Ÿä.";chat.appendChild(b);chat.scrollTop=chat.scrollHeight;isThinking=false;saveCurrentChat();},1000);}

// Auto-save chat periodically
setInterval(() => {
    if (chat.children.length > 0) {
        saveCurrentChat();
    }
}, 30000); // Save every 30 seconds

// Initial Setup Handling
function handleInitialSetup() {
    const userData = checkUser();
    
    // If user already exists, show main chat
    if (userData) {
        initialSetupCard.style.display = 'none';
        loadWelcome(userData);
        return;
    }
    
    // Show initial setup card
    initialSetupCard.style.display = 'flex';
    
    // Set minimum birth date (120 years ago)
    const minDate = new Date();
    minDate.setFullYear(minDate.getFullYear() - 120);
    initialBirthDate.min = minDate.toISOString().split('T')[0];
    
    // Set maximum birth date (today)
    const maxDate = new Date();
    initialBirthDate.max = maxDate.toISOString().split('T')[0];
    
    // Continue button handler
    continueInitialBtn.addEventListener('click', () => {
        const name = initialName.value.trim();
        const birthDate = initialBirthDate.value;
        
        if (!name || !birthDate) {
            alert('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
            return;
        }
        
        const birthDateObj = new Date(birthDate);
        const today = new Date();
        const minBirthDate = new Date();
        minBirthDate.setFullYear(today.getFullYear() - 120);
        
        if (birthDateObj > today || birthDateObj < minBirthDate) {
            alert('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ™ÿßÿ±ŸäÿÆ ŸÖŸäŸÑÿßÿØ ÿµÿ≠Ÿäÿ≠');
            return;
        }
        
        // Save user data
        saveUser(name, birthDate);
        initialSetupCard.style.display = 'none';
        loadWelcome({name: name});
    });
}

// Initialize the app
window.onload = () => {
    handleInitialSetup();
};

document.addEventListener('click',(e)=>{if(!actionBtn.contains(e.target)&&!actionMenu.contains(e.target))closeActionMenu();});
window.addEventListener('resize',adjustHeight);
document.addEventListener('keydown',(e)=>{if(profileModal.style.display==='flex'&&e.key==='Enter'){e.preventDefault();modalSaveBtn.click();}});
</script>
</body>
</html>

